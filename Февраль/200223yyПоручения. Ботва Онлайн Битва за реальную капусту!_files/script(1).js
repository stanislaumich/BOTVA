function randomWorkSaleSnowHandler(){var t={chosen:-1,blocks:[],times:[],duration:500,max:5,cycle:0.2,disable:false,last:false,type:-1,page_url:'event.php?a=worksalesnow',data_url:'event.php?a=worksalesnow&do_cmd=random&k='};t.start=function(type){t.type=type;t.max=$('#worksalesnow_blocks .worksalesnow_block.active').length;t.chosen=-1;getData();animate();};function getPage(){$.ajax({type:'get',url:t.page_url,success:function(data){$("#body").html(data);bind_titles();start_timers();}})}
function getData(){var url=t.data_url+KEY+'&type='+t.type;$.ajax({type:'post',url:url,success:function(data){if(!data.error){t.chosen=data.index;}else{t.stop();bOk(data.error);getPage();}
KEY=data.key;$('#green_upd_data').html(digits(data.have_green));},dataType:'JSON'});};function animate(){t.cycle=t.cycle+t.cycle;lock();var obj='#worksalesnow_blocks .worksalesnow_block.active';$(obj).each(function(i,e){t.blocks[i]=$(this);t.times[i]=setTimeout(function(){if(t.chosen>-1&&t.chosen==t.blocks[i].data('id')&&t.cycle>0.8){t.disabled=true;t.checkBought('#worksalesnow_block_'+t.chosen);}else if(!t.disabled){changeClasses(t.blocks[i],i);}},(t.duration*t.cycle)*i/4);});};function changeClasses(obj,num){if(!t.disabled){$(obj).addClass('bright');setTimeout(function(){$(obj).removeClass('bright');if(num+1==t.max){t.times=[];animate();}},(t.duration*t.cycle)/2);}};t.checkBought=function(block){var obj=block?block:'#worksalesnow_block_'+t.last;setTimeout(function(){if(obj){$(obj).removeClass('active');$(obj).addClass('bright');$(obj).find('.worksalesnow_block_picture').append('<div class="mine animate5">'+worksalesnow_soldout+'</div>');$(obj).find('input').prop('disabled',true);$(obj).find('.mine2').remove();$(obj).find('.buy_button').remove();setTimeout(function(){$(obj).find('.mine').addClass('rotate');},150);$(obj).find('.mine').animate({right:-22,top:17,opacity:1,fontSize:18},700,function(){$(obj).removeClass('bright');unlock();$(obj).find('mine2').show();getPage();});}},200);};t.stop=function(){$('#worksalesnow_blocks .worksalesnow_block.active').removeClass('bright');t.times=[];t.disabled=true;unlock();};function lock(){button_disable('#worksalesnow_start_choose .button_new');$('#worksalesnow_blocks .buy_button').addClass('hiddeni');$('#worksalesnow_blocks input').prop('disabled',true);}
function unlock(){button_enable('#worksalesnow_start_choose .button_new');$('#worksalesnow_blocks .buy_button').removeClass('hiddeni');$('#worksalesnow_blocks input').prop('disabled',false);}
return t;};function worksalesnowInit(){var SALE=randomWorkSaleSnowHandler();SALE.last=bought_index;$('#worksalesnow_start_choose .button_new.active').off('click').on('click',function(){if(!$(this).hasClass('cmd_blocked')){if($(this).data('type')>-1){SALE.start($(this).data('type'));}else{SALE.start();}}});$('#worksalesnow_blocks .buy_button').off('click').on('click',function(){$(this).parents('.worksalesnow_block').find('form').submit();});$('#worksalesnow_blocks .toggle_snow').off('click').on('click',function(){$.ajax({type:'post',url:SALE.page_url+'&do_cmd=toggle_snow',success:function(){doReload();}});});BG.resize();bind_titles('forced');SALE.checkBought();setTimeout(function(){$('#worksalesnow_blocks .worksalesnow_block .mine2').show();},200);}
function initSnow(){$(document).snowfall('clear');var collection=$('#body .round_block_round_border').length>0?'#body .round_block_round_border':'#body';if(typeof IS_AVATAR!='undefined'&&!IS_AVATAR){if(typeof snowfall!='undefined'&&snowfall){$(document).snowfall({round:true,minSize:2,maxSize:6,flakeCount:100});}
$('#body .toggle_snow').off('click').on('click',function(){$.ajax({type:'post',url:'event.php?a=worksale&do_cmd=toggle_snow',success:function(){doReload();}});});}};$(function(){});